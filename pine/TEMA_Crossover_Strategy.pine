//@version=6
strategy("TEMA Crossover Strategy",
         overlay=false,
         default_qty_type=strategy.cash,
         default_qty_value=100,
         initial_capital=100000,
         commission_type=strategy.commission.percent,
         commission_value=0.05,
         pyramiding=0,
         calc_on_every_tick=false,
         process_orders_on_close=false)

// ============================================================================
// Configuration
// ============================================================================

// TEMA Settings
short_window = input.int(14, "TEMA Short Window", minval=1)
long_window = input.int(51, "TEMA Long Window", minval=2)

// Position Management
stop_loss_percent = input.float(9.054410998184012, "Stop Loss %", minval=0, maxval=100)
take_profit_percent = input.float(5.0, "Take Profit %", minval=0.1, maxval=50)
max_holding_bars = input.int(21, "Max Holding Bars", minval=1)
cooldown_bars = input.int(0, "Cooldown Bars", minval=0)

// Risk Management
use_stop_loss = input.bool(true, "Use Stop Loss")
use_take_profit = input.bool(false, "Use Take Profit")
use_max_holding = input.bool(true, "Use Max Holding")
allow_flip = input.bool(true, "Allow Flip On Opposite Signal")

// Display Options
show_signals = input.bool(true, "Show Signal Markers")
show_background = input.bool(true, "Show Background Colors")
show_three_ma_lines = input.bool(true, "Show Three MA Lines")
ma_line_set = input.string("short", "MA Line Set", options=["short", "long"])

// ============================================================================
// TEMA Calculation
// ============================================================================
ema1_short = ta.ema(close, short_window)
ema2_short = ta.ema(ema1_short, short_window)
ema3_short = ta.ema(ema2_short, short_window)
tema_short = 3.0 * (ema1_short - ema2_short) + ema3_short

ema1_long = ta.ema(close, long_window)
ema2_long = ta.ema(ema1_long, long_window)
ema3_long = ta.ema(ema2_long, long_window)
tema_long = 3.0 * (ema1_long - ema2_long) + ema3_long

tema_diff = tema_short - tema_long

ema1_plot = ma_line_set == "short" ? ema1_short : ema1_long
ema2_plot = ma_line_set == "short" ? ema2_short : ema2_long
ema3_plot = ma_line_set == "short" ? ema3_short : ema3_long

// ============================================================================
// Signal Detection (matches research notebook logic)
// ============================================================================
long_entry_signal = (tema_diff[1] < 0) and (tema_diff > 0)
short_entry_signal = (tema_diff[1] > 0) and (tema_diff < 0)

long_exit_signal = short_entry_signal
short_exit_signal = long_entry_signal

// ============================================================================
// Position State Tracking
// ============================================================================
var int entry_bar = na
var int cooldown_left = 0
var int stopped_out_count = 0

is_flat = strategy.position_size == 0
is_long = strategy.position_size > 0
is_short = strategy.position_size < 0

entry_price = strategy.position_avg_price

if cooldown_left > 0 and is_flat
    cooldown_left := cooldown_left - 1

if is_long or is_short
    if na(entry_bar)
        entry_bar := bar_index
else
    entry_bar := na

bars_held = not na(entry_bar) ? bar_index - entry_bar : 0

// ============================================================================
// Entry Logic
// ============================================================================
if is_flat and cooldown_left == 0
    if long_entry_signal
        strategy.entry("Long", strategy.long, comment="Long Entry")
    else if short_entry_signal
        strategy.entry("Short", strategy.short, comment="Short Entry")

// ============================================================================
// Exit Logic - Long Position
// ============================================================================
if is_long and not na(entry_price)
    long_stop = entry_price * (1 - stop_loss_percent / 100)
    long_tp = entry_price * (1 + take_profit_percent / 100)

    if use_stop_loss and low <= long_stop
        strategy.close("Long", comment="SL")
        stopped_out_count := stopped_out_count + 1
        cooldown_left := cooldown_bars
    else if use_take_profit and high >= long_tp
        strategy.close("Long", comment="TP")
        stopped_out_count := 0
    else if long_exit_signal
        if allow_flip
            strategy.close("Long", comment="Flip")
            if cooldown_left == 0
                strategy.entry("Short", strategy.short, comment="Flip to Short")
        else
            strategy.close("Long", comment="Reverse Exit")
        stopped_out_count := 0
    else if use_max_holding and bars_held >= max_holding_bars
        strategy.close("Long", comment="Max Hold")

// ============================================================================
// Exit Logic - Short Position
// ============================================================================
if is_short and not na(entry_price)
    short_stop = entry_price * (1 + stop_loss_percent / 100)
    short_tp = entry_price * (1 - take_profit_percent / 100)

    if use_stop_loss and high >= short_stop
        strategy.close("Short", comment="SL")
        stopped_out_count := stopped_out_count + 1
        cooldown_left := cooldown_bars
    else if use_take_profit and low <= short_tp
        strategy.close("Short", comment="TP")
        stopped_out_count := 0
    else if short_exit_signal
        if allow_flip
            strategy.close("Short", comment="Flip")
            if cooldown_left == 0
                strategy.entry("Long", strategy.long, comment="Flip to Long")
        else
            strategy.close("Short", comment="Reverse Exit")
        stopped_out_count := 0
    else if use_max_holding and bars_held >= max_holding_bars
        strategy.close("Short", comment="Max Hold")

// ============================================================================
// Plot TEMA Diff and Zero Line
// ============================================================================
plot(tema_diff, "TEMA Diff", color=color.blue, linewidth=2)
hline(0, "Zero", color=color.gray, linestyle=hline.style_dashed)
plot(show_three_ma_lines ? ema1_plot : na, "EMA1 Layer", color=color.orange, linewidth=1, force_overlay=true)
plot(show_three_ma_lines ? ema2_plot : na, "EMA2 Layer", color=color.purple, linewidth=1, force_overlay=true)
plot(show_three_ma_lines ? ema3_plot : na, "EMA3 Layer", color=color.fuchsia, linewidth=1, force_overlay=true)

plotshape(show_signals and long_entry_signal and is_flat ? 0 : na,
          "Long Entry", shape.triangleup, location.absolute, color=color.lime, size=size.tiny)
plotshape(show_signals and short_entry_signal and is_flat ? 0 : na,
          "Short Entry", shape.triangledown, location.absolute, color=color.red, size=size.tiny)
plotshape(show_signals and long_exit_signal and is_long ? 0 : na,
          "Long Exit", shape.circle, location.absolute, color=color.aqua, size=size.tiny)
plotshape(show_signals and short_exit_signal and is_short ? 0 : na,
          "Short Exit", shape.circle, location.absolute, color=color.yellow, size=size.tiny)

bgcolor(show_background and tema_diff > 0 ? color.new(color.green, 94) : na, title="Bullish Regime")
bgcolor(show_background and tema_diff < 0 ? color.new(color.red, 94) : na, title="Bearish Regime")

// ============================================================================
// Info Table
// ============================================================================
var table info_table = table.new(position.top_right, 2, 8, bgcolor=color.new(color.gray, 80))
if barstate.islast
    pos_text = is_long ? "LONG" : is_short ? "SHORT" : "FLAT"
    pos_color = is_long ? color.green : is_short ? color.red : color.gray

    current_stop = is_long ? entry_price * (1 - stop_loss_percent / 100) :
                   is_short ? entry_price * (1 + stop_loss_percent / 100) : na

    table.cell(info_table, 0, 0, "Position", text_color=color.white)
    table.cell(info_table, 1, 0, pos_text, text_color=pos_color)
    table.cell(info_table, 0, 1, "TEMA Diff", text_color=color.white)
    table.cell(info_table, 1, 1, str.tostring(tema_diff, "#.####"), text_color=color.white)
    table.cell(info_table, 0, 2, "Short/Long", text_color=color.white)
    table.cell(info_table, 1, 2, str.tostring(short_window) + "/" + str.tostring(long_window), text_color=color.white)
    table.cell(info_table, 0, 3, "Entry Price", text_color=color.white)
    table.cell(info_table, 1, 3, not na(entry_price) ? str.tostring(entry_price, "#.##") : "-", text_color=color.white)
    table.cell(info_table, 0, 4, "Stop Level", text_color=color.white)
    table.cell(info_table, 1, 4, not na(current_stop) ? str.tostring(current_stop, "#.##") : "-", text_color=color.orange)
    table.cell(info_table, 0, 5, "Bars Held", text_color=color.white)
    table.cell(info_table, 1, 5, str.tostring(bars_held) + "/" + str.tostring(max_holding_bars),
               text_color=use_max_holding and bars_held >= max_holding_bars ? color.red : color.white)
    table.cell(info_table, 0, 6, "Cooldown", text_color=color.white)
    table.cell(info_table, 1, 6, str.tostring(cooldown_left), text_color=cooldown_left > 0 ? color.orange : color.white)
    table.cell(info_table, 0, 7, "Stop Count", text_color=color.white)
    table.cell(info_table, 1, 7, str.tostring(stopped_out_count), text_color=color.white)
