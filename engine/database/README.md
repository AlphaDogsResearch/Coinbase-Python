# Event Tracking Database

A comprehensive event tracking system for the trading engine that captures all events from order intent to fill, providing immediate insights into positions, orders, and full audit capabilities.

## Overview

The event tracking database provides:
- **Complete audit trail**: Track every event from signal generation to order fill
- **Position tracking**: Historical snapshots of position changes
- **Performance analysis**: Pre-built queries for strategy and order performance
- **Immediate insights**: Real-time access to orders, positions, and fills

## Architecture

### Database Schema

The system uses SQLite with SQLAlchemy ORM and consists of 5 core tables:

1. **trading_events**: Master event log for all trading-related events
2. **orders**: Order lifecycle tracking with current state
3. **fills**: Trade execution records
4. **positions**: Position state snapshots over time
5. **signals**: Trading signals generated by strategies

### Components

- **event_tracker_models.py**: SQLAlchemy ORM models
- **event_tracker.py**: Main event tracking service
- **event_queries.py**: Pre-built queries for common use cases
- **event_tracker_integration.py**: Integration wrapper for existing managers
- **example_queries.py**: Example usage patterns

## Integration

The event tracking system is integrated into:

### Order Manager (`FCFSOrderManager`)

Tracks:
- Trading signals from strategies
- Order creation and submission
- Order status updates (NEW, FILLED, CANCELED, etc.)
- Order fills with price and quantity

### Position Manager (`PositionManager`)

Tracks:
- Position updates on fills
- Position snapshots with P&L and trading costs

### Strategy Base Class (`Strategy`)

Tracks:
- Signals generated by strategies before they reach the order manager
- Strategy decisions with full context (price, action, tags)
- Automatically inherits event tracker from order manager

### Enabling/Disabling

Event tracking is **enabled by default** but can be controlled via constructor parameters:

```python
# Enable event tracking (default)
order_manager = FCFSOrderManager(
    executor=executor,
    risk_manager=risk_manager,
    reference_data_manager=ref_data_manager,
    enable_event_tracking=True,
    event_db_path="data/trading_events.db"
)

# Disable event tracking
order_manager = FCFSOrderManager(
    executor=executor,
    risk_manager=risk_manager,
    reference_data_manager=ref_data_manager,
    enable_event_tracking=False
)
```

## Usage

### Basic Usage

```python
from engine.database.event_tracker import EventTracker

# Initialize tracker
tracker = EventTracker("data/trading_events.db")

# Get recent events
events = tracker.get_recent_events(limit=20)

# Get order details
order = tracker.get_order("order_12345")

# Get current positions
positions = tracker.get_current_positions()

# Get open orders
open_orders = tracker.get_open_orders(symbol="BTCUSDT")

tracker.close()
```

### Advanced Queries

```python
from engine.database.event_tracker import EventTracker
from engine.database.event_queries import EventQueries

tracker = EventTracker("data/trading_events.db")

with tracker.session_scope() as session:
    queries = EventQueries(session)
    
    # Get complete audit trail for an order
    audit = queries.get_order_audit_trail("order_12345")
    
    # Get strategy performance metrics
    perf = queries.get_strategy_performance("momentum_strategy")
    
    # Get position timeline
    timeline = queries.get_position_timeline("BTCUSDT", hours=24)
    
    # Get order performance metrics
    metrics = queries.get_order_performance_metrics(days=7)

tracker.close()
```

### Example Queries

See `engine/database/example_queries.py` for comprehensive examples including:
- Basic usage patterns
- Audit trail queries
- Performance analysis
- Position tracking
- Order analysis
- Time range queries

Run examples:
```bash
python -m engine.database.example_queries
```

## Database Location

By default, the database is stored at:
```
data/trading_events.db
```

You can customize the location via the `event_db_path` parameter.

## Querying the Database

### Using SQLite CLI

```bash
sqlite3 data/trading_events.db

# View tables
.tables

# View schema
.schema trading_events

# Query recent events
SELECT * FROM trading_events ORDER BY timestamp DESC LIMIT 10;

# Query open orders
SELECT * FROM orders WHERE status IN ('NEW', 'OPEN', 'PARTIALLY_FILLED');

# Query fills for an order
SELECT * FROM fills WHERE order_id = 'order_12345';
```

### Using DB Browser

You can also use [DB Browser for SQLite](https://sqlitebrowser.org/) for a graphical interface.

## Performance Considerations

- **Async writes**: Event tracking uses non-blocking writes to minimize impact on trading performance
- **Connection pooling**: SQLite connection pooling for efficient database access
- **Indexed queries**: All common queries use indexed fields for fast retrieval
- **Minimal overhead**: Event tracking adds <1ms overhead per event

## Common Queries

### Get all events for an order
```python
events = tracker.get_order_events("order_12345")
```

### Get position history
```python
history = tracker.get_position_history("BTCUSDT", strategy_id="momentum_strategy")
```

### Get fills for an order
```python
fills = tracker.get_fills_for_order("order_12345")
```

### Get current positions
```python
positions = tracker.get_current_positions()
```

## Troubleshooting

### Database locked errors
If you encounter "database is locked" errors, ensure:
1. Only one process is writing to the database at a time
2. Connections are properly closed after use
3. Use the context manager (`with tracker.session_scope()`) for queries

### Missing events
If events are not being tracked:
1. Check that `enable_event_tracking=True` in manager constructors
2. Verify the database path is writable
3. Check logs for event tracker errors

## Future Enhancements

Potential improvements:
- Add database migration support with Alembic
- Implement data retention policies
- Add export to CSV/JSON functionality
- Create web dashboard for visualization
- Add real-time event streaming via WebSocket
